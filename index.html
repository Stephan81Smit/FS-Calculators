<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Freestock Slitting Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: inline-block; width: 200px; }
        input { width: 150px; padding: 5px; }
        table { width: 100%; margin: 20px 0; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        button { padding: 8px 15px; margin: 5px 5px 5px 0; cursor: pointer; }
        .result { margin-top: 20px; padding: 15px; background: #f5f5f5; }
        .summary-table { width: 100%; max-width: 600px; margin-bottom: 20px; }
        .summary-table th, .summary-table td { border: none; text-align: left; padding: 6px 8px; }
        .details-table { width: 100%; max-width: 700px; margin-top: 10px; }
        .details-table th, .details-table td { text-align: left; }
        .highlight { font-weight: bold; color: #2a5d84; }
        h1 { text-align: center; color: #1a3c5a; margin-bottom: 30px; }
        .error { border: 2px solid #ff4444 !important; }
        .error-message { color: #b22222; font-size: 0.95em; margin-left: 10px; }
        .drag-handle { cursor: move; font-weight: bold; }
        @media print {
            button, .add-remove-btn, .drag-handle { display: none !important; }
            input, select, textarea { border: none; background: transparent; }
            .container { box-shadow: none; }
            .result { background: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Freestock Slitting Calculator</h1>
        
        <div class="input-group">
            <label for="coilNo">Coil No.:</label>
            <input type="text" id="coilNo" placeholder="Enter Coil Number">
        </div>
        
        <div class="input-group">
            <label for="coilWidth">Coil Width (mm):</label>
            <input type="number" id="coilWidth" value="1225" required>
            <span class="error-message" id="coilWidthError"></span>
        </div>
        
        <div class="input-group">
            <label for="totalTrim">Total Trim (mm):</label>
            <input type="number" id="totalTrim" value="16" required>
            <span class="error-message" id="totalTrimError"></span>
        </div>

        <div class="input-group">
            <label for="materialThickness">Material Thickness (mm):</label>
            <input type="number" id="materialThickness" step="0.01" required>
            <span class="error-message" id="materialThicknessError"></span>
        </div>
        
        <div class="input-group">
            <label for="materialDensity">Density (kg/m³):</label>
            <input type="number" id="materialDensity" value="7850" required>
            <span class="error-message" id="materialDensityError"></span>
        </div>

        <h3>Slit Sizes</h3>
        <table id="slitTable">
            <thead>
                <tr>
                    <th></th>
                    <th>Slit Size (mm)</th>
                    <th>Min Qty</th>
                    <th>Max Qty</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr draggable="true">
                    <td class="drag-handle" title="Drag to reorder">☰</td>
                    <td><input type="number" class="slit-size" value="196" required></td>
                    <td><input type="number" class="min-qty"></td>
                    <td><input type="number" class="max-qty"></td>
                    <td><button class="add-remove-btn" onclick="removeRow(this)">Remove</button></td>
                </tr>
            </tbody>
        </table>
        
        <button class="add-remove-btn" onclick="addSlitRow()">Add Slit Size</button>
        <button onclick="calculateOptimization()">Calculate</button>
        <button onclick="window.print()">Print to PDF</button>
        <button onclick="clearAllSlits()">Clear All Slits</button>
        <button onclick="exportToCSV()">Export to CSV</button>

        <div id="results" class="result"></div>
    </div>

    <script>
        // Drag and Drop Functionality
        let draggedRow = null;

        document.addEventListener('dragstart', e => {
            if(e.target.classList.contains('drag-handle')) {
                draggedRow = e.target.closest('tr');
                setTimeout(() => draggedRow.style.opacity = '0.4', 0);
            }
        });

        document.addEventListener('dragend', () => {
            if(draggedRow) {
                draggedRow.style.opacity = '1';
                draggedRow = null;
            }
        });

        document.addEventListener('dragover', e => {
            e.preventDefault();
            const tbody = document.querySelector('#slitTable tbody');
            const afterElement = getDragAfterElement(tbody, e.clientY);
            
            if(afterElement) {
                tbody.insertBefore(draggedRow, afterElement);
            } else {
                tbody.appendChild(draggedRow);
            }
        });

        function getDragAfterElement(container, y) {
            return [...container.querySelectorAll('tr:not(.dragging)')].reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                return offset < 0 && offset > closest.offset ? 
                    { offset: offset, element: child } : closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Slit Row Management
        function addSlitRow() {
            const tbody = document.querySelector('#slitTable tbody');
            const newRow = document.createElement('tr');
            newRow.setAttribute('draggable', 'true');
            newRow.innerHTML = `
                <td class="drag-handle" title="Drag to reorder">☰</td>
                <td><input type="number" class="slit-size" required></td>
                <td><input type="number" class="min-qty"></td>
                <td><input type="number" class="max-qty"></td>
                <td><button class="add-remove-btn" onclick="removeRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
        }

        function clearAllSlits() {
            const tbody = document.querySelector('#slitTable tbody');
            tbody.innerHTML = `
                <tr draggable="true">
                    <td class="drag-handle" title="Drag to reorder">☰</td>
                    <td><input type="number" class="slit-size" required></td>
                    <td><input type="number" class="min-qty"></td>
                    <td><input type="number" class="max-qty"></td>
                    <td><button class="add-remove-btn" onclick="removeRow(this)">Remove</button></td>
                </tr>
            `;
        }

        // Input Validation
        function validateInputs() {
            let isValid = true;
            const requiredFields = [
                { id: 'coilWidth', min: 1 },
                { id: 'totalTrim', min: 0 },
                { id: 'materialThickness', min: 0.01 },
                { id: 'materialDensity', min: 1 }
            ];

            requiredFields.forEach(field => {
                const el = document.getElementById(field.id);
                const errorEl = document.getElementById(`${field.id}Error`);
                const value = parseFloat(el.value);

                if(isNaN(value) || value < field.min) {
                    el.classList.add('error');
                    errorEl.textContent = `Invalid value (minimum ${field.min})`;
                    isValid = false;
                } else {
                    el.classList.remove('error');
                    errorEl.textContent = '';
                }
            });

            document.querySelectorAll('#slitTable tbody tr').forEach(row => {
                const slitSize = row.querySelector('.slit-size');
                const minQty = row.querySelector('.min-qty');
                const maxQty = row.querySelector('.max-qty');
                
                if(!slitSize.value || parseFloat(slitSize.value) < 1) {
                    slitSize.classList.add('error');
                    isValid = false;
                }

                const minVal = parseFloat(minQty.value) || 0;
                const maxVal = parseFloat(maxQty.value) || Infinity;
                
                if(minVal > maxVal) {
                    minQty.classList.add('error');
                    maxQty.classList.add('error');
                    isValid = false;
                }
            });

            return isValid;
        }

        // Main Calculation Function
        function calculateOptimization() {
            if(!validateInputs()) return;

            const coilWidth = parseFloat(document.getElementById('coilWidth').value);
            const totalTrim = parseFloat(document.getElementById('totalTrim').value);
            const availableWidth = coilWidth - totalTrim;
            const thickness = parseFloat(document.getElementById('materialThickness').value);
            const density = parseFloat(document.getElementById('materialDensity').value);

            // Collect slit data
            const slits = Array.from(document.querySelectorAll('#slitTable tbody tr')).map(row => {
                const size = parseFloat(row.querySelector('.slit-size').value);
                const minQty = parseFloat(row.querySelector('.min-qty').value) || 0;
                let maxQty = parseFloat(row.querySelector('.max-qty').value);
                
                maxQty = isNaN(maxQty) ? Math.floor(availableWidth / size) : maxQty;
                maxQty = Math.max(minQty, maxQty);

                return { size, minQty, maxQty };
            }).filter(s => s.size > 0);

            // Optimization algorithm
            let bestCombination = [];
            let minWaste = availableWidth;
            let maxUsed = 0;

            function tryCombinations(index = 0, current = [], usedWidth = 0) {
                if(index === slits.length) {
                    const waste = availableWidth - usedWidth;
                    if(waste >= 0 && (waste < minWaste || (waste === minWaste && usedWidth > maxUsed))) {
                        minWaste = waste;
                        maxUsed = usedWidth;
                        bestCombination = [...current];
                    }
                    return;
                }

                const slit = slits[index];
                for(let qty = slit.minQty; qty <= slit.maxQty; qty++) {
                    const newWidth = usedWidth + (qty * slit.size);
                    if(newWidth <= availableWidth) {
                        current[index] = qty;
                        tryCombinations(index + 1, current, newWidth);
                    }
                }
            }

            tryCombinations();

            // Display results
            const resultsDiv = document.getElementById('results');
            if(bestCombination.length > 0) {
                const usedPercent = ((maxUsed / coilWidth) * 100).toFixed(2);
                const wastePercent = ((minWaste / coilWidth) * 100).toFixed(2);
                const totalWeight = (maxUsed * thickness * density) / 1000000;

                resultsDiv.innerHTML = `
                    <h3>Optimization Results</h3>
                    <table class="summary-table">
                        <tr><th>Used Width:</th><td>${maxUsed}mm (${usedPercent}%)</td></tr>
                        <tr><th>Waste:</th><td>${minWaste}mm (${wastePercent}%)</td></tr>
                        <tr><th>Total Weight:</th><td>${totalWeight.toFixed(2)} kg</td></tr>
                    </table>
                    <table class="details-table">
                        <tr><th>Slit Size</th><th>Quantity</th></tr>
                        ${slits.map((slit, i) => `
                            <tr><td>${slit.size}mm</td><td>${bestCombination[i]}</td></tr>
                        `).join('')}
                    </table>
                `;
            } else {
                resultsDiv.innerHTML = "No valid combination found";
            }
        }

        // CSV Export
        function exportToCSV() {
            const rows = [['Slit Size (mm)', 'Quantity']];
            document.querySelectorAll('.details-table tr:not(:first-child)').forEach(row => {
                const cells = Array.from(row.children).map(td => td.textContent);
                rows.push(cells);
            });

            const csvContent = rows.map(row => 
                row.join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'slitting_plan.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
